#!/usr/bin/env bash
#
# Bootstrap script for fresh macOS system
#
# This script is designed to be run on a completely fresh macOS system.
# It installs the minimal requirements and runs the portable vault executable
# to set up the rest of the system.
#
# Usage:
#   1. Copy this script and the vault executable to your fresh system
#   2. Run: ./bootstrap
#

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${BLUE}║          Vault System Bootstrap                          ║${NC}"
echo -e "${BLUE}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# Detect architecture
ARCH=$(uname -m)
OS=$(uname -s)

echo -e "${BLUE}==> Detected system${NC}"
echo -e "    OS: ${OS}"
echo -e "    Architecture: ${ARCH}"
echo ""

# Find vault executable
VAULT_EXEC=""
if [ -f "./vault" ]; then
    VAULT_EXEC="./vault"
elif [ -f "./vault_${OS}_${ARCH}" ]; then
    VAULT_EXEC="./vault_${OS}_${ARCH}"
else
    echo -e "${RED}Error: Could not find vault executable${NC}"
    echo -e "${RED}Please ensure the vault executable is in the current directory${NC}"
    exit 1
fi

echo -e "${GREEN}==> Found vault executable: ${VAULT_EXEC}${NC}"
echo ""

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    echo -e "${YELLOW}==> Installing Homebrew${NC}"
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

    # Add Homebrew to PATH for this session
    if [ -f "/opt/homebrew/bin/brew" ]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [ -f "/usr/local/bin/brew" ]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
else
    echo -e "${GREEN}==> Homebrew already installed${NC}"
fi
echo ""

# Install essential tools
echo -e "${YELLOW}==> Installing essential tools${NC}"
brew install git rsync || true
echo ""

# Create code directory
echo -e "${YELLOW}==> Creating ~/code directory${NC}"
mkdir -p ~/code
echo ""

# Show next steps
echo -e "${GREEN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║          Bootstrap Complete!                             ║${NC}"
echo -e "${GREEN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""
echo -e "${BLUE}==> Next steps:${NC}"
echo -e "    1. Clone your laptop repo:"
echo -e "       ${YELLOW}git clone <your-repo-url> ~/code/laptop${NC}"
echo ""
echo -e "    2. Run vault to restore your system:"
echo -e "       ${YELLOW}${VAULT_EXEC} restore -v /path/to/backup${NC}"
echo ""
echo -e "    3. Or use vault to install applications:"
echo -e "       ${YELLOW}${VAULT_EXEC} apps install${NC}"
echo ""
